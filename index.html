<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slot Machine Game</title>
    <!-- Update Firebase SDK with specific versions -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            font-size: 3em;
        }

        .slots-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .slot-reel {
            flex: 0 1 calc(33.333% - 20px);
            min-width: 150px;
            max-width: 200px;
        }

        @media (max-width: 768px) {
            .slot-reel {
                flex: 0 1 calc(50% - 20px);
            }
        }

        .slot-reel {
            width: 150px;
            height: 100px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            display: inline-block;
            margin: 0 5px;
        }

        .slot-window {
            position: absolute;
            width: 100%;
            height: 100px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            pointer-events: none;
            z-index: 1;
        }

        .slot-items {
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            will-change: transform;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        .slot-item {
            height: 100px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            text-transform: uppercase;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .slot-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .spin-button {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #121212;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .spin-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }

        .spin-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .payout-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payout-item {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            padding: 10px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 8px;
            margin: 5px 0;
            font-weight: bold;
        }

        .payout-item[style*="rgba(255, 255, 255, 0.1)"] {
            border-left: 4px solid #00ff88;
        }

        .payout-item.show {
            opacity: 1;
            transform: translateY(0);
        }

        .payout-display {
            position: absolute;
            top: -40px;  /* Position above the reel */
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 255, 136, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            color: #fff;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .payout-display.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .total-payout {
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.5s ease;
            padding: 15px;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
        }

        .total-payout.show {
            opacity: 1;
            transform: scale(1);
        }

        #result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 1.4em;
            transition: opacity 0.5s ease;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
            border: 2px solid rgba(0, 255, 136, 0.1);
        }

        /* Add these new CSS rules */
        @keyframes flashColor {
            0% { background: transparent; }
            50% { background: rgba(255, 255, 255, 0.3); }
            100% { background: transparent; }
        }

        @keyframes goldPulse {
            0% { background: rgba(243, 156, 18, 0.1); }
            50% { background: rgba(243, 156, 18, 0.4); }
            100% { background: rgba(243, 156, 18, 0.1); }
        }

        .cherry {
            position: absolute;
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 1000;
            animation: fall 3s linear forwards;
        }

        @keyframes fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
            }
        }

        .flash-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 999;
        }

        .slot-lever-container,
        .slot-lever,
        .slot-lever.dragging,
        .slot-lever.pulled,
        .lever-handle,
        .lever-base,
        .slot-lever::after {
            display: none;
        }

        .slots-container {
            position: relative;
            margin-right: 0; /* Changed from 80px */
        }

        .screen-flash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 9999;
            animation: screenFlash 0.5s ease-out forwards;
        }

        @keyframes screenFlash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .fruit-list-container {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .fruit-item {
            display: inline-flex;
            align-items: center;
            margin: 5px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 14px;
        }

        .fruit-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }

        .upgrades-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            background: rgba(0, 255, 136, 0.1);
            padding: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .upgrades-icon:hover {
            transform: rotate(90deg);
            background: rgba(0, 255, 136, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            margin: 15% auto;
            padding: 20px;
            width: 70%;
            max-width: 600px;
            border-radius: 15px;
            border: 2px solid #00ff88;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.3);
        }

        .close-button {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            color: #00ff88;
            cursor: pointer;
        }

        .close-button:hover {
            color: #00cc6a;
        }

        .upgrade-button {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #121212;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upgrade-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }

        .upgrade-button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        /* Add login styles */
        .login-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .login-form {
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 300px;
        }

        .login-form input {
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #333;
            background: #222;
            color: white;
        }

        .login-form button {
            padding: 0.5rem;
            border-radius: 5px;
            border: none;
            background: #00ff88;
            color: #121212;
            cursor: pointer;
            font-weight: bold;
        }

        .login-form button:hover {
            background: #00cc6a;
        }

        #userInfo {
            position: fixed;
            top: 10px;
            right: 10px;
            color: #00ff88;
            z-index: 100;
        }

        #logoutBtn {
            margin-left: 10px;
            padding: 5px 10px;
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid red;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Add this near the top of the body, before the game container -->
    <div class="auth-buttons">
        <div id="userInfo" style="display: none">
            <span id="userEmail"></span>
            <button class="auth-button" onclick="openUsernameModal()">Set Username</button>
            <button class="auth-button" onclick="window.location.href='leaderboard.html'">Leaderboard</button>
            <button class="auth-button logout" onclick="logout()">Logout</button>
        </div>
        <div id="loginPrompt">
            <button class="auth-button login" onclick="window.location.href='login.html'">Login / Register</button>
            <button class="auth-button" onclick="window.location.href='leaderboard.html'">Leaderboard</button>
        </div>
    </div>

    <!-- Add this right after the auth-buttons div -->
    <div id="usernameModal" class="username-modal">
        <div class="username-modal-content">
            <h2>Choose Your Username</h2>
            <p>Please enter a username to continue:</p>
            <input type="text" id="usernameInput" class="username-input" placeholder="Enter username" maxlength="20">
            <p id="usernameError" style="color: #ff4444; display: none;"></p>
            <button onclick="submitUsername()" class="username-submit">Submit</button>
        </div>
    </div>

    <style>
        .auth-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }

        .auth-button {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #121212;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .auth-button.logout {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
        }

        .username-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .username-modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00ff88;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .username-input {
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .username-submit {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #121212;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .username-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }
    </style>

    <div class="container">
        <h1>Slot Machine</h1>
        <div class="balance-container">
            Balance: $<span id="balance">100</span>
        </div>
        <div class="slots-container">
            <div class="slot-reel" id="reel1">
                <div class="slot-window"></div>
                <div class="slot-items"></div>
            </div>
            <div class="slot-reel" id="reel2">
                <div class="slot-window"></div>
                <div class="slot-items"></div>
            </div>
            <div class="slot-reel" id="reel3">
                <div class="slot-window"></div>
                <div class="slot-items"></div>
            </div>
            <div class="slot-reel" id="reel4">
                <div class="slot-window"></div>
                <div class="slot-items"></div>
            </div>
            <div class="slot-reel" id="reel5">
                <div class="slot-window"></div>
                <div class="slot-items"></div>
            </div>
            <div class="slot-reel" id="reel6">
                <div class="slot-window"></div>
                <div class="slot-items"></div>
            </div>
        </div>
        <button class="spin-button" id="spinButton">SPIN ($20)</button>
        <p id="result"></p>
        <div class="fruit-list-container">
            <h3>Items</h3>
            <div id="fruitList"></div>
        </div>
    </div>

    <!-- Upgrades Modal -->
    <div id="upgradesModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Upgrades</h2>
            <button id="nextReelButton" class="upgrade-button">Unlock Next Reel</button>
        </div>
    </div>

    <!-- Upgrades Icon -->
    <div class="upgrades-icon">‚öôÔ∏è</div>

    <script>
        // Add this debounce function at the top of your script
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Create a debounced version of saveGameProgress
        const debouncedSave = debounce(async function() {
            if (!auth.currentUser) return;

            try {
                await db.collection('users').doc(auth.currentUser.uid).set({
                    balance: balance,
                    inventory: inventory,
                    unlockedReels: unlockedReels,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Progress saved successfully');
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }, 1000); // Will only save after 1 second of no changes

        // Replace all saveGameProgress() calls with debouncedSave()
        function saveGameProgress() {
            debouncedSave();
        }

        // Define the rarities with fruits
        const rarities = [
            { name: "Common", color: "#808080", chance: 44.99, multiplier: 1.5, value: 1 },       // Grey (44.99%)
            { name: "Uncommon", color: "#00cc00", chance: 35, multiplier: 2.0, value: 30 },        // Green (35%)
            { name: "Rare", color: "#0066ff", chance: 15, multiplier: 3.0, value: 250 },            // Blue (15%)
            { name: "Very Rare", color: "#9933ff", chance: 3, multiplier: 4.0, value: 500 },       // Purple (3%)
            { name: "Epic", color: "#ff9900", chance: 1.5, multiplier: 6.0, value: 1000 },          // Orange (1.5%)
            { name: "Legendary", color: "#ff0000", chance: 0.3, multiplier: 15.0, value: 2500 },    // Red (0.3%)
            { name: "üçí", color: "#ffff00", chance: 0.2, multiplier: 25.0, value: 10000 },      // Gold (0.2%) - Changed from "Mythic" to cherry
            { name: "JACKPOT", color: "#ff00ff", chance: 0.01, multiplier: 50.0, value: 25000 }    // Pink (0.01%)
        ];

        // Initialize inventory object
        let inventory = {};

        // Function to update the fruit list display
        function updateFruitList() {
            const fruitList = document.getElementById('fruitList');
            fruitList.innerHTML = '';
            
            rarities.forEach(fruit => {
                if (inventory[fruit.name] && inventory[fruit.name] > 0) {
                    const item = document.createElement('div');
                    item.className = 'fruit-item';
                    item.style.cursor = 'pointer'; // Add pointer cursor
                    
                    const colorDot = document.createElement('span');
                    colorDot.className = 'fruit-color';
                    colorDot.style.backgroundColor = fruit.color;
                    
                    item.appendChild(colorDot);
                    item.appendChild(document.createTextNode(
                        `${fruit.name} x${inventory[fruit.name]} ($${fruit.value})`
                    ));
                    
                    // Add click handler to sell fruit
                    item.addEventListener('click', () => sellFruit(fruit.name));
                    
                    fruitList.appendChild(item);
                }
            });
        }

        // Function to add fruit to inventory
        function addToInventory(fruit) {
            inventory[fruit.name] = (inventory[fruit.name] || 0) + 1;
            updateFruitList();
            saveGameProgress(); // Save after adding to inventory
        }

        function sellFruit(fruitName) {
            if (inventory[fruitName] > 0) {
                const rarity = rarities.find(r => r.name === fruitName);
                balance += rarity.value;
                inventory[fruitName]--;
                updateBalance();
                updateFruitList();
                
                if (rarity.value >= 5000) {
                    createCherryRain();
                }
                saveGameProgress(); // Save after selling fruit
            }
        }

        function sellAllFruit(fruitName) {
            if (inventory[fruitName] > 0) {
                const rarity = rarities.find(r => r.name === fruitName);
                const totalValue = rarity.value * inventory[fruitName];
                balance += totalValue;
                inventory[fruitName] = 0;
                updateBalance();
                updateFruitList();
                
                if (totalValue >= 5000) {
                    createCherryRain();
                }
                saveGameProgress(); // Save after selling all fruit
            }
        }

        function createFloatingText(text, color) {
            const floatingText = document.createElement('div');
            floatingText.style.cssText = `
                position: fixed;
                color: ${color};
                font-size: 24px;
                font-weight: bold;
                pointer-events: none;
                animation: floatUp 2s ease-out forwards;
                z-index: 1000;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
            `;
            floatingText.textContent = text;
            document.body.appendChild(floatingText);
            
            setTimeout(() => floatingText.remove(), 2000);
        }

        // Initialize variables at the top level
        const SPIN_COST = 20;
        let balance = 100;
        let isSpinning = false;
        let unlockedReels = 1;
        let secretCode = '';
        let isAdmin = false;
        const selectedBet = SPIN_COST; // Since SPIN_COST is being used as the bet amount
        let adminPanel = document.createElement('div'); // Temporary element for admin panel

        // Add reel prices
        const reelPrices = {
            2: 5000,    // Price for second reel
            3: 10000,   // Price for third reel
            4: 25000,   // Price for fourth reel
            5: 50000,   // Price for fifth reel
            6: 100000   // Price for sixth reel
        };

        function initializeSlots() {
            const slotsContainer = document.querySelector('.slots-container');
            slotsContainer.innerHTML = '';
            
            // Create all 6 reels
            for (let i = 1; i <= 6; i++) {
                const reel = document.createElement('div');
                reel.className = 'slot-reel';
                reel.id = `reel${i}`;
                
                const window = document.createElement('div');
                window.className = 'slot-window';
                
                const items = document.createElement('div');
                items.className = 'slot-items';
                
                // Add slot items
                for (let j = 0; j < 10; j++) {
                    rarities.forEach(rarity => {
                        const item = document.createElement('div');
                        item.className = 'slot-item';
                        item.style.backgroundColor = rarity.color;
                        item.textContent = rarity.name;
                        items.appendChild(item);
                    });
                }
                
                reel.appendChild(window);
                reel.appendChild(items);
                slotsContainer.appendChild(reel);
            }

            updateReelVisibility();

            // Initialize spin button
            const spinButton = document.getElementById('spinButton');
            spinButton.addEventListener('click', () => {
                if (!isSpinning && balance >= SPIN_COST) {
                    spinSlots();
                }
            });

            updateBalance();
        }

        function spinSlots() {
            if (isSpinning || balance < SPIN_COST) return;
            
            isSpinning = true;
            balance -= SPIN_COST;
            updateBalance();
            
            const results = [];
            const activeReels = document.querySelectorAll('.slot-reel');
            
            // Only process the number of unlocked reels
            for (let i = 0; i < unlockedReels; i++) {
                const reel = activeReels[i];
                const items = reel.querySelector('.slot-items');
                const resultRarity = getRandomRarity();
                results.push(resultRarity);
                
                const itemHeight = 100;
                const totalHeight = itemHeight * rarities.length;
                const targetIndex = rarities.findIndex(r => r.name === resultRarity.name);
                const numberOfRotations = 2 + Math.floor(Math.random() * 2);
                const finalPosition = -(totalHeight * numberOfRotations + (targetIndex * itemHeight));
                
                items.style.transition = 'none';
                items.style.transform = 'translateY(0)';
                items.offsetHeight;
                
                items.style.transition = `transform ${3 + i * 0.5}s cubic-bezier(0.45, 0.05, 0.55, 0.95)`;
                items.style.transform = `translateY(${finalPosition}px)`;
            }

            setTimeout(() => {
                // Add items from all unlocked reels
                results.forEach(resultRarity => {
                    addToInventory(resultRarity);
                });
                
                isSpinning = false;
                updateBalance();
            }, 4500);
        }

        function getRandomRarity() {
            const random = Math.random() * 100;
            let cumulative = 0;
            
            for (const rarity of rarities) {
                cumulative += rarity.chance;
                if (random <= cumulative) {
                    return rarity;
                }
            }
            
            return rarities[0]; // Default to common if something goes wrong
        }

        // Store the original getRandomRarity function right after its definition
        const originalGetRandomRarity = getRandomRarity;

        function calculateMultiplier(results) {
            let totalMultiplier = 0;
            const individualPayouts = [];
            
            // First, show what rarities were hit
            results.forEach((result, index) => {
                individualPayouts.push({
                    name: `Reel ${index + 1}: ${result.name}`,
                    multiplier: 0,
                    payout: 0,
                    isRarityDisplay: true
                });
            });
            
            // Count occurrences of each symbol
            const counts = {};
            results.forEach(result => {
                counts[result.name] = (counts[result.name] || 0) + 1;
            });
            
            // Calculate payouts for matches with increased multipliers
            for (const [name, count] of Object.entries(counts)) {
                const rarity = rarities.find(r => r.name === name);
                
                if (count >= 2) {
                    let multiplier = 0;
                    
                    if (count === 3) {
                        multiplier = rarity.multiplier * 8;  // Increased from 6
                        individualPayouts.push({
                            name: `Triple ${name}`,
                            multiplier: multiplier,
                            payout: multiplier * selectedBet
                        });
                    } else if (count === 2) {
                        multiplier = rarity.multiplier * 3.5;  // Increased from 2.5
                        individualPayouts.push({
                            name: `Double ${name}`,
                            multiplier: multiplier,
                            payout: multiplier * selectedBet
                        });
                    }
                    
                    totalMultiplier += multiplier;
                }
            }

            // Add bonus for single symbols with increased values
            results.forEach(result => {
                let bonus = 0;
                let bonusName = '';
                
                switch(result.name) {
                    case "Mythic":
                        bonus = 3.0;    // Increased from 2.0
                        bonusName = "Mythic Bonus";
                        break;
                    case "Legendary":
                        bonus = 2.0;    // Increased from 1.0
                        bonusName = "Legendary Bonus";
                        break;
                    case "Epic":
                        bonus = 1.5;    // Increased from 0.5
                        bonusName = "Epic Bonus";
                        break;
                    case "Rare":
                        bonus = 1.2;    // Increased from 0.3
                        bonusName = "Rare Bonus";
                        break;
                    case "Uncommon":
                        bonus = 1.0;    // Increased from 0.2
                        bonusName = "Uncommon Bonus";
                        break;
                    case "Common":
                        bonus = 0.8;    // Increased from 0.1
                        bonusName = "Common Bonus";
                        break;
                }
                
                if (bonus > 0) {
                    totalMultiplier += bonus;
                    individualPayouts.push({
                        name: bonusName,
                        multiplier: bonus,
                        payout: bonus * selectedBet
                    });
                }
            });

            // Minimum payout guarantee increased
            if (totalMultiplier > 0 && totalMultiplier < 1.0) {  // Increased from 0.5
                totalMultiplier = 1.0;  // Ensures you at least get your bet back
                individualPayouts.push({
                    name: "Minimum Payout Bonus",
                    multiplier: 1.0,
                    payout: 1.0 * selectedBet
                });
            }

            return {
                totalMultiplier: Math.max(totalMultiplier, 0),
                individualPayouts: individualPayouts
            };
        }

        function showPayoutEffects(payoutInfo) {
            const result = document.getElementById("result");
            result.innerHTML = '';
            
            if (payoutInfo.totalMultiplier > 0) {
                const totalElement = document.createElement('div');
                totalElement.className = 'total-payout';
                totalElement.textContent = `Total Win: $${(payoutInfo.totalMultiplier * selectedBet).toFixed(2)}`;
                result.appendChild(totalElement);
                
                setTimeout(() => {
                    totalElement.classList.add('show');
                }, 300);
            }
            // Removed the else block that showed "Try again!"
        }

        function adjustColor(color, amount) {
            return color;  // For now, just return the same color
        }

        function updateBalance() {
            balance = Number(balance); // Ensure balance is a number
            document.getElementById("balance").textContent = balance.toFixed(2);
            const spinButton = document.getElementById('spinButton');
            if (spinButton) {
                spinButton.disabled = isSpinning || balance < SPIN_COST;
            }
            if (typeof updateShopButton === 'function') {
                updateShopButton();
            }
        }

        function createCherryRain() {
            const container = document.querySelector('.container');
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const cherry = document.createElement('img');
                    cherry.src = 'cherry.webp';
                    cherry.className = 'cherry';
                    cherry.style.left = Math.random() * 100 + 'vw';
                    cherry.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(cherry);
                    
                    // Remove cherry after animation
                    setTimeout(() => cherry.remove(), 3000);
                }, i * 100);
            }
        }

        function flashReelColor(reel, color) {
            const flash = document.createElement('div');
            flash.className = 'flash-effect';
            flash.style.animation = `flashColor 0.5s ease`;
            flash.style.background = color;
            reel.appendChild(flash);
            
            setTimeout(() => flash.remove(), 500);
        }

        function showSpecialEffects(results) {
            // Define colors for high-tier symbols
            const specialColors = {
                'Epic': 'rgba(142, 68, 173, 0.5)',
                'Legendary': 'rgba(243, 156, 18, 0.5)',
                'Mythic': 'rgba(192, 57, 43, 0.5)'
            };

            // Create a container for the flash effects if it doesn't exist
            let flashContainer = document.querySelector('.flash-container');
            if (!flashContainer) {
                flashContainer = document.createElement('div');
                flashContainer.className = 'flash-container';
                document.body.appendChild(flashContainer);
            }

            // Clear any existing flash effects
            flashContainer.innerHTML = '';

            // Flash effects for high-tier symbols
            const highTierResults = results.map((result, index) => ({
                result,
                index,
                color: specialColors[result.name]
            })).filter(item => item.color);

            // Sequence the flashes
            highTierResults.forEach((item, i) => {
                setTimeout(() => {
                    flashScreenColor(item.color);
                }, i * 500); // 500ms between each flash
            });

            // Check for Mythic symbols and create tornado
            results.forEach((result, index) => {
                if (result.name === 'Mythic') {
                    setTimeout(() => {
                        createCherryTornado();
                    }, index * 200);
                }
            });

            // Special effects for three of a kind
            if (results[0].name === results[1].name && results[1].name === results[2].name) {
                if (results[0].name === 'Legendary') {
                    setTimeout(() => {
                        document.body.style.animation = 'goldPulse 1s ease infinite';
                        setTimeout(() => {
                            document.body.style.animation = '';
                        }, 3000);
                    }, highTierResults.length * 500);
                }
                else if (results[0].name === 'Mythic') {
                    setTimeout(() => {
                        createCherryTornado();
                        createCherryTornado();
                    }, 500);
                }
            }
        }

        function flashScreenColor(color) {
            const flash = document.createElement('div');
            flash.className = 'screen-flash';
            flash.style.background = color;
            document.body.appendChild(flash);
            
            // Remove the flash element after animation
            setTimeout(() => flash.remove(), 500);
        }

        // Add these new functions
        function setMoney(amount) {
            balance = amount;
            updateBalance();
            saveGameProgress(); // Save after setting money
        }

        function createMatrixRain() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789$@#";
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const elem = document.createElement('div');
                    elem.className = 'matrix-character';
                    elem.style.left = Math.random() * 100 + 'vw';
                    elem.style.animation = `matrixRain ${1 + Math.random() * 2}s linear`;
                    elem.textContent = chars[Math.floor(Math.random() * chars.length)];
                    document.body.appendChild(elem);
                    setTimeout(() => elem.remove(), 3000);
                }, i * 100);
            }
        }

        function createExplosion(x, y) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = x + 'px';
            explosion.style.top = y + 'px';
            explosion.style.animation = 'explosion 0.5s ease-out forwards';
            document.body.appendChild(explosion);
            setTimeout(() => explosion.remove(), 500);
        }

        function createCherryTornado() {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            let angle = 0;
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const cherry = document.createElement('img');
                    cherry.src = 'cherry.webp';
                    cherry.className = 'cherry';
                    const radius = 100 + (i * 5);
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);
                    cherry.style.left = x + 'px';
                    cherry.style.top = y + 'px';
                    document.body.appendChild(cherry);
                    angle += 0.2;
                    setTimeout(() => cherry.remove(), 2000);
                }, i * 50);
            }
        }

        let jackpotMode = false;

        function triggerEffect(effect) {
            switch(effect) {
                case 'rainbow':
                    document.body.style.animation = 'rainbow 2s linear infinite';
                    setTimeout(() => document.body.style.animation = '', 5000);
                    break;
                case 'matrix':
                    createMatrixRain();
                    break;
                case 'explosions':
                    for (let i = 0; i < 10; i++) {
                        setTimeout(() => {
                            createExplosion(
                                Math.random() * window.innerWidth,
                                Math.random() * window.innerHeight
                            );
                        }, i * 200);
                    }
                    break;
                case 'spinningReels':
                    document.querySelectorAll('.slot-reel').forEach(reel => {
                        reel.style.animation = 'spin 0.5s linear infinite';
                        setTimeout(() => reel.style.animation = '', 2000);
                    });
                    break;
                case 'cherryTornado':
                    createCherryTornado();
                    break;
                case 'jackpotMode':
                    jackpotMode = !jackpotMode;
                    if (jackpotMode) {
                        getRandomRarity = () => rarities[rarities.length - 1]; // Always return Mythic
                    } else {
                        getRandomRarity = originalGetRandomRarity;
                    }
                    break;
                case 'crazyColors':
                    const reels = document.querySelectorAll('.slot-reel');
                    reels.forEach(reel => {
                        setInterval(() => {
                            reel.style.backgroundColor = 
                                '#' + Math.floor(Math.random()*16777215).toString(16);
                        }, 100);
                    });
                    setTimeout(() => reels.forEach(reel => 
                        reel.style.backgroundColor = ''), 3000);
                    break;
            }
        }


        // Add keyboard listener for secret code
        document.addEventListener('keydown', (e) => {
            // Only add the actual key pressed, not the full key name
            secretCode += e.key.toLowerCase();
            
            // Keep only the last 7 characters
            if (secretCode.length > 7) {
                secretCode = secretCode.slice(-7);
            }

            // Check if the code matches
            if (secretCode === 'beanman') {
                isAdmin = !isAdmin;
                
                // Create admin panel if it doesn't exist
                if (!adminPanel) {
                    adminPanel = document.createElement('div');
                    adminPanel.style.position = 'fixed';
                    adminPanel.style.top = '10px';
                    adminPanel.style.right = '10px';
                    adminPanel.style.background = 'rgba(0,0,0,0.8)';
                    adminPanel.style.padding = '10px';
                    adminPanel.style.borderRadius = '5px';
                    adminPanel.innerHTML = `
                        <button onclick="setMoney(1000000)">Add $1M</button>
                        <button onclick="triggerEffect('rainbow')">Rainbow</button>
                        <button onclick="triggerEffect('matrix')">Matrix</button>
                        <button onclick="triggerEffect('explosions')">Explosions</button>
                        <button onclick="triggerEffect('cherryTornado')">Cherry Tornado</button>
                        <button onclick="triggerEffect('jackpotMode')">Toggle Jackpot Mode</button>
                    `;
                    document.body.appendChild(adminPanel);
                }
                
                adminPanel.style.display = isAdmin ? 'block' : 'none';
                secretCode = '';  // Reset the code after successful activation
            }
        });

        // Initialize
        initializeSlots();
        updateBalance();

        function celebrateJackpot(jackpotType, color, amount) {
            // Create massive celebration effects
            createMatrixRain();
            document.body.style.animation = 'rainbow 2s linear infinite';
            
            // Multiple cherry tornados - more tornados for bigger jackpots
            const tornadoCount = amount >= 100000 ? 8 : (amount >= 25000 ? 6 : 4);
            for (let i = 0; i < tornadoCount; i++) {
                setTimeout(() => {
                    createCherryTornado();
                }, i * 500);
            }
            
            // Create explosions all over the screen - more explosions for bigger jackpots
            const explosionCount = amount >= 100000 ? 30 : (amount >= 25000 ? 20 : 10);
            for (let i = 0; i < explosionCount; i++) {
                setTimeout(() => {
                    createExplosion(
                        Math.random() * window.innerWidth,
                        Math.random() * window.innerHeight
                    );
                }, i * 200);
            }
            
            // Show jackpot message
            const result = document.getElementById("result");
            result.innerHTML = `üé∞ ${jackpotType}! üé∞<br>$${(amount * selectedBet).toLocaleString()}`;
            result.style.fontSize = '3em';
            result.style.color = color;
            result.style.textShadow = `0 0 20px ${color}`;
            
            // Add shake animation for grand jackpot
            if (amount >= 100000) {
                document.querySelector('.container').style.animation = 'shake 0.5s infinite';
            }
            
            // Reset celebrations after 5 seconds
            setTimeout(() => {
                document.body.style.animation = '';
                document.querySelector('.container').style.animation = '';
                result.style.fontSize = '';
                result.style.color = '';
                result.style.textShadow = '';
            }, 5000);
        }

        // Add this HTML after the slots-container div
        const shopHTML = `
            <div class="shop-container">
                <h2>Unlock Next Reel</h2>
                <div class="shop-items">
                    <button class="shop-button" id="nextReelButton"></button>
                </div>
            </div>
        `;

        // Add this CSS
        const shopStyles = `
            .shop-container {
                margin: 20px 0;
                padding: 15px;
                background: rgba(0, 0, 0, 0.8);
                border-radius: 10px;
                border: 2px solid #00ff88;
            }

            .shop-items {
                display: flex;
                justify-content: center;
            }

            .shop-button {
                background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                color: #121212;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .shop-button:disabled {
                background: #333;
                color: #666;
                cursor: not-allowed;
            }

            .slot-reel {
                opacity: 0.3;
                pointer-events: none;
            }

            .slot-reel.unlocked {
                opacity: 1;
                pointer-events: auto;
            }
        `;

        function initializeShop() {
            const container = document.querySelector('.container');
            const slotsContainer = document.querySelector('.slots-container');
            slotsContainer.insertAdjacentHTML('afterend', shopHTML);

            const styleSheet = document.createElement('style');
            styleSheet.textContent = shopStyles;
            document.head.appendChild(styleSheet);

            updateReelVisibility();

            const nextReelButton = document.getElementById('nextReelButton');
            nextReelButton.addEventListener('click', () => {
                const nextReel = unlockedReels + 1;
                const price = reelPrices[nextReel];
                
                if (balance >= price) {
                    balance -= price;
                    unlockedReels = nextReel;
                    updateBalance();
                    updateReelVisibility();
                    updateShopButton();
                    initializeSlots(); // Reinitialize slots with new reel
                    
                    // Celebration effect
                    createExplosion(
                        nextReelButton.offsetLeft + nextReelButton.offsetWidth/2, 
                        nextReelButton.offsetTop + nextReelButton.offsetHeight/2
                    );
                }
            });

            updateShopButton();
        }

        function updateReelVisibility() {
            document.querySelectorAll('.slot-reel').forEach((reel, index) => {
                if (index < unlockedReels) {
                    reel.classList.add('unlocked');
                    reel.style.display = 'block';
                } else {
                    reel.classList.remove('unlocked');
                    reel.style.display = 'none';
                }
            });
        }

        function updateShopButton() {
            const nextReelButton = document.getElementById('nextReelButton');
            const nextReel = unlockedReels + 1;
            
            if (nextReel <= 6) {
                const price = reelPrices[nextReel];
                nextReelButton.textContent = `Unlock Reel ${nextReel} ($${price.toLocaleString()})`;
                nextReelButton.disabled = balance < price;
                nextReelButton.style.display = 'block';
            } else {
                nextReelButton.style.display = 'none';
            }
        }

        function initializeUpgradesSystem() {
            const upgradesIcon = document.querySelector('.upgrades-icon');
            const modal = document.getElementById('upgradesModal');
            const closeButton = document.querySelector('.close-button');

            upgradesIcon.addEventListener('click', () => {
                modal.style.display = 'block';
                updateShopButton();
            });

            closeButton.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            const nextReelButton = document.getElementById('nextReelButton');
            nextReelButton.addEventListener('click', () => {
                const nextReel = unlockedReels + 1;
                const price = reelPrices[nextReel];
                
                if (balance >= price) {
                    balance -= price;
                    unlockedReels = nextReel;
                    updateBalance();
                    updateReelVisibility();
                    updateShopButton();
                    
                    // Celebration effect
                    createExplosion(
                        nextReelButton.offsetLeft + nextReelButton.offsetWidth/2, 
                        nextReelButton.offsetTop + nextReelButton.offsetHeight/2
                    );
                    
                    saveGameProgress(); // Save after purchasing new reel
                }
            });

            updateShopButton();
        }

        // Call initializeShop after the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeSlots();
            initializeUpgradesSystem();
        });

        // Initialize Firebase with your config
        const firebaseConfig = {
            apiKey: "AIzaSyD_TsiHkiF3sbpojB3ZsiVwKeUb6qtcUWc",
            authDomain: "slot-machines-36445.firebaseapp.com",
            projectId: "slot-machines-36445",
            storageBucket: "slot-machines-36445.firebasestorage.app",
            messagingSenderId: "12445326097",
            appId: "1:12445326097:web:bda94e8e7b9a3f40fbcab0",
            measurementId: "G-1YZZS02KXV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        // Authentication functions
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                hideLoginScreen();
                loadUserProgress(userCredential.user);
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                hideLoginScreen();
                initializeUserProgress(userCredential.user);
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        // Game state management
        function saveGameProgress() {
            debouncedSave();
        }

        async function loadUserProgress(user) {
            if (!user) return; // Exit if no user

            try {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    // Set all the saved values
                    balance = Number(data.balance) || 100;
                    inventory = data.inventory || {};
                    unlockedReels = Number(data.unlockedReels) || 1;

                    console.log('Loaded user data:', {
                        balance: balance,
                        unlockedReels: unlockedReels,
                        inventory: inventory
                    });

                    // Update UI
                    updateBalance();
                    updateReelVisibility();
                    if (typeof updateFruitList === 'function') {
                        updateFruitList();
                    }
                    
                    // Show the game container
                    const gameContainer = document.querySelector('.container');
                    if (gameContainer) {
                        gameContainer.style.display = 'block';
                    }
                } else {
                    console.log('No existing user data, initializing new profile');
                    // Initialize new user data with default values
                    initializeUserProgress(user);
                }
            } catch (error) {
                console.error('Error loading user progress:', error);
            }
        }

        async function initializeUserProgress(user) {
            const defaultData = {
                balance: 100,
                inventory: {},
                unlockedReels: 1,
                username: null,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('users').doc(user.uid).set(defaultData);
                // Set the initial values in the game
                balance = defaultData.balance;
                inventory = defaultData.inventory;
                unlockedReels = defaultData.unlockedReels;
                
                // Update UI
                updateBalance();
                updateReelVisibility();
                if (typeof updateFruitList === 'function') {
                    updateFruitList();
                }
                
                console.log('Initialized new user data:', defaultData);
            } catch (error) {
                console.error('Error initializing user progress:', error);
            }
        }

        // UI helpers
        function showLoginScreen() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'none';
            document.querySelector('.container').style.display = 'none';
        }

        function hideLoginScreen() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.querySelector('.container').style.display = 'block';
        }

        // Modify existing functions to save progress
        const originalSpinSlots = spinSlots;
        spinSlots = function() {
            originalSpinSlots();
            setTimeout(saveGameProgress, 4500);
        }

        const originalSellFruit = sellFruit;
        sellFruit = function(fruitName) {
            originalSellFruit(fruitName);
            saveGameProgress();
        }

        // Add these functions to your existing JavaScript
        async function checkUsername(user) {
            // Do nothing - we no longer automatically check for username
        }

        function showUsernameModal() {
            const modal = document.getElementById('usernameModal');
            modal.style.display = 'flex';
        }

        async function submitUsername() {
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            const errorElement = document.getElementById('usernameError');
            
            // Reset error message
            errorElement.style.display = 'none';
            
            if (username.length < 3) {
                errorElement.textContent = 'Username must be at least 3 characters long';
                errorElement.style.display = 'block';
                return;
            }

            if (!auth.currentUser) {
                errorElement.textContent = 'You must be logged in to set a username';
                errorElement.style.display = 'block';
                return;
            }

            try {
                // Check if username is already taken
                const usernameQuery = await db.collection('users')
                    .where('username', '==', username)
                    .get();
                
                if (!usernameQuery.empty) {
                    errorElement.textContent = 'Username is already taken';
                    errorElement.style.display = 'block';
                    return;
                }

                // Update the user's document with the new username
                await db.collection('users').doc(auth.currentUser.uid).update({
                    username: username
                });

                // Hide the modal
                document.getElementById('usernameModal').style.display = 'none';
                console.log('Username set successfully');

                // Update the display
                const userEmail = document.getElementById('userEmail');
                if (userEmail) {
                    userEmail.textContent = `${username} (${auth.currentUser.email})`;
                }
            } catch (error) {
                console.error('Error setting username:', error);
                errorElement.textContent = 'Error setting username. Please try again.';
                errorElement.style.display = 'block';
            }
        }

        // Add a function to manually show the username modal
        function openUsernameModal() {
            if (!auth.currentUser) {
                alert('You must be logged in to set a username');
                return;
            }
            showUsernameModal();
        }

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            const userInfo = document.getElementById('userInfo');
            const loginPrompt = document.getElementById('loginPrompt');
            const gameContainer = document.querySelector('.container');
            
            if (user) {
                console.log('User logged in:', user.email);
                if (userInfo) userInfo.style.display = 'block';
                if (loginPrompt) loginPrompt.style.display = 'none';
                
                // Only update display with existing username if it exists
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (userInfo && data.username) {
                            document.getElementById('userEmail').textContent = `${data.username} (${user.email})`;
                        } else {
                            document.getElementById('userEmail').textContent = user.email;
                        }
                    } else {
                        document.getElementById('userEmail').textContent = user.email;
                    }
                });
                
                // Load user progress
                loadUserProgress(user);
            } else {
                console.log('User logged out');
                if (userInfo) userInfo.style.display = 'none';
                if (loginPrompt) loginPrompt.style.display = 'block';
                if (gameContainer) gameContainer.style.display = 'none';
                
                // Reset to default values
                balance = 100;
                inventory = {};
                unlockedReels = 1;
                updateBalance();
                updateReelVisibility();
            }
        });

        // Show login screen on initial load
        showLoginScreen();
    </script>
</body>
</html>
